# Apuntes Ciclo 07 - Turbo - Cash Flow

# Arreglar problema de bundle install creando binstubs

El error al correr el comando bundle install

    Beginning in Rails 4, Rails ships with a `rails` binstub at ./bin/rails that
    should be used instead of the Bundler-generated `rails` binstub.
    
    If you are seeing this message, your binstub at ./bin/rails was generated by
    Bundler instead of Rails.
    
    You might need to regenerate your `rails` binstub locally and add it to source
    control:
    
     rails app:update:bin           # Bear in mind this generates other binstubs
                                    # too that you may or may not want (like yarn)
    
    If you already have Rails binstubs in source control, you might be
    inadvertently overwriting them during deployment by using bundle install
    with the --binstubs option.
    
    If your application was created prior to Rails 4, here's how to upgrade:
    
      bundle config --delete bin    # Turn off Bundler's stub generator
      rails app:update:bin          # Use the new Rails executables
      git add bin                   # Add bin/ to source control
    
    You may need to remove bin/ from your .gitignore as well.
    
    When you install a gem whose executable you want to use in your app,
    generate it and add it to source control:
    
      bundle binstubs some-gem-name
      git add bin/new-executable

Resulta que en el archivo de configuración de bundle hay una instrucción para crear binstubs de las gemas. Entonces terminaba con un poco de binarios en la carpeta `bin/` y eso no era necesario.

La solución es ubicar dónde está el archivo que está usando bundle y luego quitar la línea `BUNDLE_BIN`:

    $ bundle config
    Settings are listed in order of priority. The top value will be used.
    bin
    Set for your local app (/Users/francisco/projects/devaspros-projects/cashflow/.bundle/config): false

En ese archivo se busca la instrucción mencionada y se cambia su valor a false o se quita del todo:

    $ cat .bundle/config 
    ---
    BUNDLE_BIN: "false"

Visto en [Stack Overflow](https://stackoverflow.com/a/35636208/1407371).


# Sobre matchers para pruebas de vistas

Si no se instala capybara, el único matcher disponible es:

    .match(/regexp/)
    
    # ejemplo
    expect(rendered).to match(/Principal/)

Una vez instalado capybara se tiene acceso a una lista más completa.

    have_selector


# Cambiando la zona horaria

Por defecto es UTC y cuando creaba registros tarde por la noche, salían con fecha del día siguiente.

Para corregir hay que cambiar la zona horaria en la configuración general pero cuando se muestren  datos con fechas hay que hacerles un ajuste para que se acomoden a UTC.

    # config/application.rb
    
    module Cashflow
      class Application < Rails::Application
        config.time_zone = "America/Bogota"
      end
    end

Luego en la vista

    <%= l(Time.zone.local_to_utc(expenditure.spent_at), format: :short) %>

Enlaces:

- Docs de `TimeZone` [https://api.rubyonrails.org/classes/ActiveSupport/TimeZone.html](https://api.rubyonrails.org/classes/ActiveSupport/TimeZone.html)
- Aquí se menciona esta forma de lograrlo - [Stack Overflow](https://stackoverflow.com/questions/16818180/ruby-rails-change-the-timezone-of-a-time-without-changing-the-value)


# Ejecutar comandos de despliegue como usuario ubuntu en Github Action

Detalles sobre códigos de error en Linux:

    El exit code 126 es error de permisos:
        126 Command invoked cannot execute
        
    El exit code 1 es error génerico:
        Error: Process completed with exit code 1.

Estaba intentando pasar la clave del usuario `ubuntu` del servidor desde el GitHub action pero eso no era lo que había que hacer.

    ssh cashflow_cloud 'echo Superman123. | sudo -u *** bash -c "~/cashflow/deployments/api-release/scripts/deploy_api.sh"'
      shell: /usr/bin/bash -e {0}
    
    bash: /home/***/cashflow/deployments/api-release/scripts/deploy_api.sh: Permission denied
    
    Error: Process completed with exit code 126.

Con esta forma sí está entrando y ejecutando los scripts:

    ssh cashflow_cloud 'cat .clave | sudo -S -u ubuntu bash ~/cashflow/deployments/api-release/scripts/deploy_api.sh'

pero cuando llega a

    sudo ln -sfv /home/ubuntu/.nvm/versions/node/v18.16.1/bin/node /usr/local/bin/node >> /home/ubuntu/deployment_logs/004_node_symlink.log 2>&1

explota con el error de la contraseña:

    2023-07-20 04:16:58 Symlink NVM node to /usr/local/bin/node
    sudo: a terminal is required to read the password; either use the -S option to read from standard input or configure an askpass helper


## Pregunta

¿Será que debo configurar la clave como stdin desde ese script?

Resulta que sí y así quedó el script:

    # SYMLINK NVM node to /usr/local/bin/node
    #
    echo "$(date '+%F %T') Symlink NVM node to /usr/local/bin/node" >> /home/ubuntu/deployment_logs/004_node_symlink.log 2>&1
    cat ~/.clave | sudo -S ln -sfv /home/ubuntu/.nvm/versions/node/v18.16.1/bin/node /usr/local/bin/node >> /home/ubuntu/deployment_logs/004_node_symlink.log 2>&1

Y en toda parte donde hacía falta la clave, se prefijaba con los comandos necesarios:

    cat ~/.clave | sudo -S


# Crear un color hexadecimal random

En [SO](https://stackoverflow.com/a/11265881/1407371):

    SecureRandom.hex(3)
    #=> "fef912"


# cron que corra cada dos horas

Debe ser así para Ubuntu:

    0 */2 * * * bash /home/ubuntu/cashflow/app/scripts/backup_db.sh >> /home/ubuntu/deployment_logs/100_cron.log 2>&1


# Caja de búsqueda con Turbo

Hay que envolver todo lo que se necesite cambiar sin hacer un refresco completo en un `turbo_frame_tag`:

    <%= turbo_frame_tag "expenditures" do %>
      <div class="d-flex flex-wrap justify-content-between">
        <%== pagy_bootstrap_nav(@pagy) %>
    
        <div class="search-box">
          <%= form_with url: search_index_path, method: :get, class: "input-group", data: { turbo_frame: "expenditures" } do |form| %>
            <%= form.text_field :query, placeholder: "descripción o categoría", class: "form-control" %>
            <%= form.submit "Buscar", class: "btn btn-primary" %>
          <% end %>
        </div>
      </div>
    <% end %>

En el controlador hay que responder con un `turbo_stream`:

    def index
      @pagy, @expenditures = pagy(expenditures)
    
      respond_to do |format|
        format.html { render 'expenditures/index' }
    
        format.turbo_stream do
          render turbo_stream: turbo_stream.replace(
            "expenditures"
          )
        end
      end
    end

Nótese que siempre hago referencia al objetivo para poner el nuevo HTML en “expenditures”.

Y eso es todo lo necesario.

