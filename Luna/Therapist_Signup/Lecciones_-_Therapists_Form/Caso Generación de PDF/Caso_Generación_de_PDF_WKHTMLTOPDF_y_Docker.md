# Caso Generación de PDF: WKHTMLTOPDF y Docker

Mientras estaba en entorno de desarrollo/local, la generación de los archivos PDF con `wkhtmltopdf` funcionaba normal porque la dependencia está instalada mediante la gema `wkhtmltopdf-binary` y a su vez las dependencias del software están instaladas en macOS.

## Lista de Issues

- [Works in prod but not dev:](https://github.com/mileszs/wicked_pdf/issues/753) `[Error: PDF could not be generated! Command Error:](https://github.com/mileszs/wicked_pdf/issues/753)`
- [not working in production server](https://github.com/mileszs/wicked_pdf/issues/743)
- [doesn't work on Alpine](https://github.com/zakird/wkhtmltopdf_binary_gem/issues/53)
- [sh: wkhtmltopdf: not found](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3739)

## Situación En Staging

Una vez pasamos a *staging* y cómo estos entornos están bajo una configuración con Docker la cosa se complica.

Primero, las funciones que generan los PDFs y los cargan a S3 se ejecutan en segundo plano. Las tareas en segundo plano son ejecutadas con *Resque* en un contenedor diferente a la aplicación Rails pero con la misma configuración. Por ello, **se tenía la creencia** que los archivos se generaban pero resulto ser falso al verificar con el envío del PDF con los términos y condiciones de Luna.

Hay un error que se ve en los logs de la aplicación Rails:

    ["/usr/local/bundle/bin/wkhtmltopdf", "--viewport-size", "1024x768", "--lowquality", "file:////tmp/wicked_pdf20191022-66-2af78d.html", "/tmp/wicked_pdf_generated_file20191022-66-a3wjg1.pdf"]
    Error: PDF could not be generated!
     Command Error:

En primera instancia, creía que era que no estaba instalado `wkhtmltopdf` y resulta que el sistema sí haya a `wkhtmltopdf` pero no retorna nada al usarlo:

    /usr/src/app # wkhtmltopdf
    /usr/src/app # wkhtmltopdf -V
    /usr/src/app # /usr/local/bundle/bin/wkhtmltopdf --viewport-size 1024x768 --lowquality https://google.com google.pdf
    /usr/src/app # /usr/local/bundle/bin/wkhtmltopdf
    /usr/src/app # /usr/local/bundle/bin/wkhtmltopdf https://google.com google.pdf
    /usr/src/app # 

Ninguna invocación ejecuta algo. Nada. En todo caso, resulta que dicho programa no es el binario que se creería sino un *binstub*.

    /usr/src/app # which wkhtmltopdf
    /usr/local/bundle/bin/wkhtmltopdf
    /usr/src/app # ls -l /usr/local/bundle/bin/wkhtmltopdf
    -rwxr-xr-x    1 root     root           584 Oct 22 20:01 /usr/local/bundle/bin/wkhtmltopdf
    /usr/src/app # cat /usr/local/bundle/bin/wkhtmltopdf
    #!/usr/bin/env ruby
    #
    # This file was generated by RubyGems.
    #
    # The application 'wkhtmltopdf-binary' is installed as part of a gem, and
    # this file is here to facilitate running it.
    #
    # (...)
    if Gem.respond_to?(:activate_bin_path)
    load Gem.activate_bin_path('wkhtmltopdf-binary', 'wkhtmltopdf', version)
    else
    gem "wkhtmltopdf-binary", version
    load Gem.bin_path("wkhtmltopdf-binary", "wkhtmltopdf", version)
    end

En palabras de [*unixmonkey*](https://github.com/mileszs/wicked_pdf/issues/743#issuecomment-394406044):

> It looks to me like the binary may actually be a binstub. These are sometimes little Ruby scripts that figure out your environment a bit before calling the actual `wkhtmltopdf` binary. These can be created as part of a gem that provides `wkhtmltopdf` or a Ruby switcher like `rbenv`.
## Intentando con dependencias en el Dockerfile

Lo primero que encuentro al buscar es [este issue](https://github.com/mileszs/wicked_pdf/issues/753) en el repo de `wicked_pdf` muy similar pero al final se resuelve al actualizar la gema. En el [último comentario](https://github.com/mileszs/wicked_pdf/issues/753#issuecomment-507848061), alguien comenta que hay que instalar `wkhtmltopdf` en el sistema si se usa Linux Alpine, una imagen de Docker.

En el mismo issue, el usuario *unixmonkey* hace mención a unas [líneas de código](https://github.com/mileszs/wicked_pdf/blob/master/lib/wicked_pdf.rb#L55) y que podría estar disparando el error:

    def pdf_from_url(url, options = {})
      # merge in global config options
      options.merge!(WickedPdf.config) { |_key, option, _config| option }
      generated_pdf_file = WickedPdfTempfile.new('wicked_pdf_generated_file.pdf', options[:temp_path])
      command = [@exe_path]
      command += parse_options(options)
      command << url
      command << generated_pdf_file.path.to_s
     # (...)
      pdf = generated_pdf_file.read
      raise "Error generating PDF\n Command Error: #{err}" if options[:raise_on_all_errors] && !err.empty?
      raise "PDF could not be generated!\n Command Error: #{err}" if pdf && pdf.rstrip.empty?
      pdf
    
     # (...)
    end

En todo caso, sigo buscando y [encuentro otro issue](https://github.com/mileszs/wicked_pdf/issues/743) del mismo repositorio(`wicked_pdf`) con un error similar:

    RuntimeError (Failed to execute:
    ["/usr/local/bin/wkhtmltopdf", "-q", "file:////tmp/wicked_pdf20180531-994-1x8fbfn.html", "/tmp/wicked_pdf_generated_file20180531-994-1vidmtk.pdf"]
    Error: PDF could not be generated!
    
    Command Error: /usr/bin/env: ruby: No such file or directory
    ):

Acá **sí** se específica el error en cambio en el error que estoy experimentando no aparece nada.

La respuesta sugiere indicar la ruta del ejecutable de `wkhtmltopdf` al initcalizador de `wicked_pdf`.

    # config/initializers/wicked_pdf.rb
    
    WickedPdf.config = {
      exe_path: '/usr/local/bin/wkhtmltopdf'
    }

En todo caso, como estoy usando la gema `wkhtmltopdf-binary` se supone que esto no es necesario. Finalmente, en el último comentario, alguien sugiere instalar dependencias de `wkhtmltopdf`.

Más adelante, voy a repositorio de `wkhtmltopdf-binary` y busco en los issues para encontrar que [al parecer](https://github.com/zakird/wkhtmltopdf_binary_gem/issues/53) `[wkhtmltopdf](https://github.com/zakird/wkhtmltopdf_binary_gem/issues/53)` [no funciona con imágenes Docker hechas a partir de Linux Alpine](https://github.com/zakird/wkhtmltopdf_binary_gem/issues/53)(una versión sumamente ligera).

La recomendación del issue es **no usar la gema y en su lugar instalar el software directamente en la imagen Docker**:

> I'm using docker image ruby:2.6.3-alpine and this gem didn't work. To work, you have to install by `apk add wkhtmltopdf`

**Linux Alpine no va bien con wkhtmltopdf**
En [este](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3739) [*issue*](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3739) del mismísimo `wkhtmltopdf` es donde [se menciona que Linux Alpine no trabaja bien con este programa](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3739#issuecomment-378606531) debido a que la versión de Linux no soporta GNU libc:

> Ok, here's an update. The problem is, that Alpine does not support GNU libc. More details can be found in this issue: [gliderlabs/docker-alpine#219](https://github.com/gliderlabs/docker-alpine/issues/219)
> So the hard truth is: No wkhtmltopdf on Alpine for now, at least no easy way.

[Un comentario más adelante](https://github.com/wkhtmltopdf/wkhtmltopdf/issues/3739#issuecomment-469844073) indica que si se quiere que este software trabaje en Linux Alpine hay que instalar las siguientes librerías:

    I'm sorry for commenting on an old, closed ticket.
    In case anyone is looking to make wkhtmltopdf work in Alpine, the following packages need to be installed:
            - libxrender
            - libxext
            - gcompat
    EDIT: These packages were deduced by running ldd $(which wkhtmltopdf).
## Cómo Descubrí que no se estaban generando los PDF en segundo plano

Ya que Ryan no me da acceso a los elementos del Bucket de Terapeutas en *staging*, decidí que la forma para verificar sería usando la API de S3 mediante la gema que está instalada en el proyecto.

Busqué en la documentación de las clases `[Aws::S3::Client](https://docs.aws.amazon.com/sdkforruby/api/Aws/S3/Client.html#list_objects-instance_method)` y `[Aws::S3::Object](https://docs.aws.amazon.com/sdkforruby/api/Aws/S3/Object.html#download_file-instance_method)` para ver con qué contaría para listar y verificar objetos en el bucket. Así lo hice.

**Listando Objetos en el Bucket**

    s3_client = Aws::S3::Client.new(
      region: ENV["AWS_REGION"],
      access_key_id: ENV["AWS_ACCESS_KEY_ID"],
      secret_access_key: ENV["AWS_SECRET_ACCESS_KEY"]
    )
    
    r = s3_client.list_objects(
      bucket: ENV['AWS_S3_BUCKET_NAME'],
      prefix: 'zapata_duvan_10222019'
    )
    
    p r.to_h
    
    r.contents.each do |o|
      p o.key
      p "#" * 50
    end

**Descargando Objeto del Bucket**

    s3_client = Aws::S3::Client.new(
      region: ENV["AWS_REGION"],
      access_key_id: ENV["AWS_ACCESS_KEY_ID"],
      secret_access_key: ENV["AWS_SECRET_ACCESS_KEY"]
    )
    
    object = Aws::S3::Object.new(
      bucket_name: ENV['AWS_S3_BUCKET_NAME'],
      key: "zapata_duvan_10222019/signup/signup.pdf",
      client: s3_client
    )
    
    object.download_file('./tmp/descarga.pdf')

Si el objeto no existe, se devuelve el error:

    Aws::S3::Errors::NotFound ()
## Docker Alpine, WKHTMLTOPDF y las Dependencias

Luego de solventar la solución de que `wkhtmltopdf` no funcionara, quedó otro detalle en que el PDF se generaba sin texto alguno.

Solo se veían los campos de texto que están el HTML y salían vacíos.

![[pdf.vacio.png]]


Al final, para resolver el detalle había que instalar varias dependencias faltantes que necesita `wkhtmltopdf` que no vienen en Docker Alpine:

    ENV BUNDLE_WITHOUT="development test" \
        APP=/usr/src/app/ \
        RAILS_ENV=production \
        BUILD_PACKAGES="build-base" \
        DEV_PACKAGES="(...)fontconfig-dev freetype-dev libx11-dev libxext-dev libxrender-dev" \
        RUNTIME_PACKAGES="(...)wkhtmltopdf libxrender libxext gcompat fontconfig freetype ttf-dejavu ttf-droid ttf-freefont ttf-liberation ttf-ubuntu-font-family"

Solo hasta cuando instalé `ttf-dejavu ttf-droid ttf-freefont ttf-liberation ttf-ubuntu-font-family` el texto empezó a aparecer.

**Repos con Dockerfiles que configuran** `**wkhtmltopdf**`

- [docker-alpine-wkhtmltopdf-patched-qt](https://github.com/aantonw/docker-alpine-wkhtmltopdf-patched-qt/blob/master/Dockerfile)
- [Alpine build](https://github.com/wkhtmltopdf/packaging/issues/2)
- [docker-wkhtmltopdf](https://github.com/Surnet/docker-wkhtmltopdf)
- [Opencomp Dockerfiles](https://github.com/Opencomp/Dockerfiles/blob/master/wkhtmltopdf/0.12.5/0.12.5-alpine3.10/Dockerfile)
- [wkhtmltopdf packaging repo](https://github.com/wkhtmltopdf/packaging/blob/0.12/docker/Dockerfile.debian)

