# Booking Specs written by Claude

These were generated by Claude. I did not added this to the codebase because I did not wanted to delay more the merging.

```ruby
RSpec.describe Api::V1::External::HubspotTherapistDirectAccessEntryWebhookController, type: :request do
  let(:route) { "/api/v1/external/hubspot/therapist_direct_access_entry_webhook" }
  let(:therapist) { FactoryBot.create(:therapist, region: region) }
  let(:account) { therapist.account }
  let(:region) { FactoryBot.create(:region) }
  let(:california) { FactoryBot.create(:state, name: "California") }
  let(:patient) { FactoryBot.create(:patient, region: region) }
  let(:clinic) { FactoryBot.create(:clinic, region: region) }
  
  let(:valid_params) do
    {
      associated_contact_record_id: account.hubspot_id,
      direct_access_restricted: "No",
      therapist_name_state: "John Doe - California",
      association_label: "active",
      hs_object_id: "12345678901",
      hs_createdate: "2025-7-01"
    }
  end

  before do
    account.update!(hubspot_id: "hubspot_contact_123")
  end

  describe "POST #create" do
    context "when therapist exists" do
      it "creates a new therapist direct access entry" do
        expect {
          post route, params: valid_params
        }.to change(TherapistDirectAccessEntry, :count).by(1)

        expect(response).to have_http_status(:created)
        expect(JSON.parse(response.body)["success"]).to be true

        entry = TherapistDirectAccessEntry.last
        expect(entry.therapist).to eq(therapist)
        expect(entry.state.name).to eq("California")
        expect(entry.association_label).to eq("active")
        expect(entry.permitted).to be true
        expect(entry.hubspot_id).to eq(12345678901)
      end

      it "updates an existing entry" do
        existing_entry = FactoryBot.create(
          :therapist_direct_access_entry,
          therapist: therapist,
          state: california,
          hubspot_id: "12345678901",
          permitted: false
        )

        post route, params: valid_params

        expect(response).to have_http_status(:ok)
        expect(JSON.parse(response.body)["success"]).to be true

        existing_entry.reload
        expect(existing_entry.permitted).to be true
        expect(existing_entry.association_label).to eq("active")
      end

      context "with invalid data" do
        let(:invalid_params) do
          valid_params.merge(therapist_name_state: "Invalid Format")
        end

        it "returns unprocessable entity for new record" do
          post route, params: invalid_params

          expect(response).to have_http_status(:unprocessable_entity)
          expect(JSON.parse(response.body)["success"]).to be false
          expect(JSON.parse(response.body)["errors"]).to be_present
        end

        it "destroys existing invalid record" do
          existing_entry = FactoryBot.create(
            :therapist_direct_access_entry,
            therapist: therapist,
            state: california,
            hubspot_id: "12345678901"
          )

          expect {
            post route, params: invalid_params
          }.to change(TherapistDirectAccessEntry, :count).by(-1)

          expect(response).to have_http_status(:ok)
          expect(JSON.parse(response.body)["success"]).to be false
        end
      end
    end

    context "when therapist does not exist" do
      let(:nonexistent_params) do
        valid_params.merge(associated_contact_record_id: nil)
      end

      it "returns not modified status" do
        post route, params: nonexistent_params, as: :json

        expect(response).to have_http_status(:not_modified)
        # expect(JSON.parse(response.body)["success"]).to be true
        expect(TherapistDirectAccessEntry.count).to eq(0)
      end
    end
  end

  describe "DART/DAPT booking scenarios integration" do
    let(:medical_referral_episode) do
      FactoryBot.create(
        :episode,
        patient: patient,
        clinic: clinic,
        referral_url: Faker::Internet.url,
        status: :active
      )
    end

    let(:direct_access_episode) do
      FactoryBot.create(
        :episode,
        patient: patient,
        clinic: clinic,
        referral_url: nil,
        status: :active
      )
    end

    context "when creating DART therapist entry" do
      before do
        post route, params: valid_params.merge(association_label: "active")
      end

      it "creates therapist with direct access permissions" do
        expect(response).to have_http_status(:created)
        
        dart_entry = TherapistDirectAccessEntry.find_by(therapist: therapist, state: california)
        expect(dart_entry).to be_present
        expect(dart_entry.permitted).to be true
        expect(dart_entry.association_label).to eq("active")
      end

      it "allows booking with medical referral episode" do
        appointment = FactoryBot.create(
          :appointment,
          episode: medical_referral_episode,
          therapist: therapist,
          scheduled_date: 1.week.from_now
        )

        expect(appointment.persisted?).to be true
        expect(medical_referral_episode.referral_type).to eq(:referred)
      end

      it "allows booking with direct access episode in permitted state" do
        # Set patient in California to match therapist permission
        patient.region.update!(name: "California")
        
        appointment = FactoryBot.create(
          :appointment,
          episode: direct_access_episode,
          therapist: therapist,
          scheduled_date: 1.week.from_now
        )

        expect(appointment.persisted?).to be true
        expect(direct_access_episode.referral_type).to eq(:direct_access)
      end
    end

    context "when creating DAPT therapist entry" do
      before do
        post route, params: valid_params.merge(association_label: "active_attesting")
      end

      it "creates therapist with active attesting status" do
        expect(response).to have_http_status(:created)
        
        dapt_entry = TherapistDirectAccessEntry.find_by(therapist: therapist, state: california)
        expect(dapt_entry).to be_present
        expect(dapt_entry.permitted).to be true
        expect(dapt_entry.association_label).to eq("active_attesting")
      end

      it "therapist qualifies for active_or_active_attesting scope" do 
        qualified_therapists = Therapist.joins(:direct_access_entries)
                                       .merge(TherapistDirectAccessEntry.active_or_active_attesting)
                                       .where(therapist_direct_access_entries: { permitted: true })

        expect(qualified_therapists).to include(therapist)
      end
    end

    context "when creating restricted therapist entry" do
      let(:restricted_params) do
        valid_params.merge(
          direct_access_restricted: "Yes: CA < 1 year experience",
          association_label: "active"
        )
      end

      before do
        post route, params: restricted_params
      end

      it "creates therapist with restricted permissions" do
        expect(response).to have_http_status(:created)
        
        restricted_entry = TherapistDirectAccessEntry.find_by(therapist: therapist, state: california)
        expect(restricted_entry).to be_present
        expect(restricted_entry.permitted).to be false
        expect(restricted_entry.association_label).to eq("active")
      end

      it "still allows booking with medical referral episode" do
        appointment = FactoryBot.create(
          :appointment,
          episode: medical_referral_episode,
          therapist: therapist,
          scheduled_date: 1.week.from_now
        )

        expect(appointment.persisted?).to be true
        expect(medical_referral_episode.referral_type).to eq(:referred)
      end
    end
  end

  describe "helper methods for qualification checking" do
    let!(:dart_entry) do
      FactoryBot.create(
        :therapist_direct_access_entry,
        :permitted,
        :active,
        therapist: therapist,
        state: california
      )
    end

    def can_practice_direct_access?(therapist, state)
      therapist.direct_access_entries.active_or_active_attesting.where(state: state, permitted: true).exists?
    end

    it "correctly identifies qualified therapists" do
      expect(can_practice_direct_access?(therapist, california)).to be true

      # Use find_or_create_by to ensure we get a different state
      other_state = State.find_or_create_by(name: "New York") do |state|
        state.assign_attributes(FactoryBot.attributes_for(:state, name: "New York"))
      end
      
      expect(other_state.name).to eq("New York")  # Verify it's actually different
      expect(can_practice_direct_access?(therapist, other_state)).to be false
    end

    it "identifies therapists by qualification status" do
      qualified_therapists = Therapist.joins(:direct_access_entries)
                                     .merge(TherapistDirectAccessEntry.active_or_active_attesting)
                                     .where(therapist_direct_access_entries: { 
                                       permitted: true, 
                                       state: california 
                                     })

      expect(qualified_therapists).to include(therapist)
    end
  end

  describe "data parsing methods" do
    describe "therapist_name_state parsing" do
      it "correctly parses valid format" do
        state = TherapistDirectAccessEntry.get_state_from_therapist_name_state("John Doe - California")
        expect(state.name).to eq("California")
      end

      it "returns nil for invalid format" do
        state = TherapistDirectAccessEntry.get_state_from_therapist_name_state("Invalid Format")
        expect(state).to be_nil
      end
    end

    describe "direct_access_restricted parsing" do
      it "returns true for 'No'" do
        permitted = TherapistDirectAccessEntry.get_permitted_from_direct_access_restricted("No")
        expect(permitted).to be true
      end

      it "returns false for restriction descriptions" do
        permitted = TherapistDirectAccessEntry.get_permitted_from_direct_access_restricted("Yes: CA < 1 year experience")
        expect(permitted).to be false
      end
    end

    describe "timestamp parsing" do
      it "correctly parses integer timestamps" do
        timestamp = TherapistDirectAccessEntry.get_hubspot_created_at_from_hs_createdate(1640995200000)
        expect(timestamp).to be_a(Time)
        expect(timestamp.year).to eq(2022)
      end

      it "correctly parses string timestamps" do
        timestamp = TherapistDirectAccessEntry.get_hubspot_created_at_from_hs_createdate("2022-01-01T00:00:00Z")
        expect(timestamp).to be_a(Time)
        expect(timestamp.year).to eq(2022)
      end

      it "returns nil for blank input" do
        timestamp = TherapistDirectAccessEntry.get_hubspot_created_at_from_hs_createdate("")
        expect(timestamp).to be_nil
      end
    end
  end

  describe "referral type determination" do
    it "identifies medical referral episodes correctly" do
      referral_episode = FactoryBot.create(
        :episode,
        patient: patient,
        clinic: clinic,
        referral_url: "https://example.com/referral.pdf",
        status: :active
      )

      expect(referral_episode.referral_type).to eq(:referred)
    end

    it "identifies direct access episodes correctly" do
      direct_episode = FactoryBot.create(
        :episode,
        patient: patient,
        clinic: clinic,
        referral_url: nil,
        status: :active
      )

      expect(direct_episode.referral_type).to eq(:direct_access)
    end
  end
end
```

