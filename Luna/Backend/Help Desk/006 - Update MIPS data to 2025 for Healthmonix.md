# 006 - Update MIPS data to 2025 metrics and send to data Healthmonix

Etiquetas: #luna_help_desk 

Caso EDG-2693.

Reporte:
> In preparation to submit for MIPS.
>
> Currently, this data lives in a MIPS Table and ER Files that updates on a daily basis. Historically, the data was sent via SFTP in an autogenerated matter to files on MIPS Pro

> [!Tip]
> La spreadsheet dice:
> > *Exclude Other, Pelvis & Upper Back Injury Types*

# Componentes Clave

## Tabla settings

### `healthmonix_#{year}_integration_enabled`

> [!Important]
> Controls whether files are uploaded to SFTP.

Hay registros por cada a帽o en la tabla `settings` cuya `key` sigue el patr贸n `healthmonix_#{year}_integration_enabled` que almacena un booleano. Entonces tenemos:

- `healthmonix_2024_integration_enabled`: true
- `healthmonix_2023_integration_enabled`: true
- `healthmonix_2022_integration_enabled`: false

Y la de 2025:

- `healthmonix_2025_integration_enabled`: true

> [!Note]
> Para alpha no existe ninguno de estos registros.

### `healthmonix_#{year}_states`

> [!Important]
> Which states to include.

Este es un setting que guarda una lista de estados de USA en forma abreviada. Sigue el mismo patr贸n que `healthmonix_#{year}_integration_enabled`.

- `healthmonix_2024_states`: "AZ,CA,FL,IL,TX,WA,GA,NY,CO"
- `healthmonix_2023_states`: "AZ,CA,FL,IL,TX,WA"
- `healthmonix_2022_states`: "CA"

Y para 2025:

- `healthmonix_2025_states`: "AZ,CA,FL,IL,TX,WA,GA,NY,CO"

> [!Note]
> Para alpha no existe ninguno de estos registros.

### `healthmonix_#{year}_strictly_contained`

> [!Important]
> Controls whether to include only care plans that started AND ended within the year

Lo mismo que los dos anteriores. Este setting guarda un valor booleano. Veamos lo que hay:

- `healthmonix_2022_strictly_contained`: true
- `healthmonix_2023_strictly_contained`: false
- `healthmonix_2024_strictly_contained`: false
- `healthmonix_2025_strictly_contained`: false

> [!Note]
> Para alpha no existe ninguno de estos registros.

## Workers

Hay un worker principal que dispara los dem谩s. El orden que sigue es:

- `Athena::HealthmonixCompleteDataWriterWorker`: hace el trigger de `Athena::HealthmonixYearDataWriterWorker` por cada a帽o empezando en 2022
	- Se configura en `periodic_jobs` con cron `CRON_DAILY_AT_2_AM`
- `Athena::HealthmonixYearDataWriterWorker`: hace la generaci贸n y export de los datos

Secuencia:
```
Athena::HealthmonixCompleteDataWriterWorker (runs daily at 2:00 AM PT)
		> Spawns Athena::HealthmonixYearDataWriterWorker for year 2022
		> Spawns Athena::HealthmonixYearDataWriterWorker for year 2023
		> Spawns Athena::HealthmonixYearDataWriterWorker for year 2024
		> Should spawn for year 2025 (automatic based on current year)
```

## Flujo de los Datos

Seg煤n Claudio:

For each year and state:
1. **Query Database**: Complex SQL query filters appointments based on year, state, injury type, etc.
2. **Merge with Forms Data**: Fetches patient assessment forms from AWS Athena
3. **Generate CSV**: Creates CSV with patient outcomes data
4. **Upload to S3**: Stores in `business-operations/healthmonix/{year}/{state}/{date}/data.csv`
5. **Upload to SFTP (if enabled)**: Uses registration ID and integration key to create filename

> [!Note]
> Para alpha, en S3 hay carpetas de 2023 y 2025 pero dada la falta de registros en `settings` no hay datos relevantes.

## Nombre del archivo en el servidor FTP

Claudio dice:

Format:  `Quality_{registration_id}_{integration_key}_{date_string}.csv`

Ejemplos:
- 2023: Includes date string (e.g., `Quality_17625_egAuLG7aVx_20251001.csv`)
- 2024+: No date string (e.g., `Quality_21742_MlUGF8grFd.csv`)

# Problema

El problema parece ser solo para el a帽o 2025 porque no est谩 el case para este a帽o en su lugar.

## Issue 1: Faltan los Registration IDs para 2025

En la funci贸n `get_sftp_filename` falta cubrir el a帽o 2025:
```ruby
def get_sftp_filename(year, state)
	registration_id, integration_key =
		case year
		when 2022
			case state.postal_abbreviation
			when "CA"
			else
				["UNKNOWN-2022-REGISTRATION-ID", "UNKNOWN-2022-INTEGRATION-KEY"]
			end
		when 2023
			case state.postal_abbreviation
			when "CA"
			when "AZ"
			when "FL"
			when "IL"
			when "TX"
			when "WA"
			else
				["UNKNOWN-2023-REGISTRATION-ID", "UNKNOWN-2023-INTEGRATION-KEY"]
			end
		when 2024
			case state.postal_abbreviation
			when "CA"
			when "AZ"
			when "FL"
			when "IL"
			when "TX"
			when "WA"
			when "GA"
			when "NY"
			when "CO"
			else
				["UNKNOWN-2023-REGISTRATION-ID", "UNKNOWN-2023-INTEGRATION-KEY"]
			end
		else
			["UNKNOWN-#{year}-REGISTRATION-ID", "UNKNOWN-#{year}-INTEGRATION-KEY"]
		end

	date_string = (Time.zone.today.iso8601.gsub("-", "") if year == 2023)

	"#{['Quality', registration_id, integration_key, date_string].compact.join('_')}.csv"
end
```

### Soluci贸n: Dar soporte al a帽o 2025 y copiar los registration IDs 

Los valores est谩n en la spreadsheet que se comparti贸 en el reporte. Hay que agregar al case los nueve estados que se identifican en la 1era hoja y hacer el emparejamiento con sus respectivos registration_id e integration_key.

## Issue 2: Actualizaci贸n de c贸digo MSK11 al MSK15

En el commit de la actualizaci贸n de 2024 Ryan hizo este cambio:
```ruby
if functional_treatment.present?
	nprs_treatment =
		functional_treatment
		# code
		.gsub("MSK02", "MSK12")
		.gsub("MSK01", "MSK11")
		.gsub("MSK03", "MSK13")
		.gsub("MSK04", "MSK14")
		.gsub("MSK05", "MSK15")

	result_nprs["Treatment"] = nprs_treatment
end
```

Ahora para 2025 se pide:
> To note, MSK11-15 changed, which was noted in the "Visit Table-Column" tab and "Mapping Logic 2025" tab.

Cuando veo la hoja de c谩lculo en la tab "Visit Table-Column" dice
> New Mapping table-No longer any measures with MSK11, MSK 12, MSK13, MSK 14, MSK15

Y cuando reviso en "Mapping Logic 2025" encuentro que hay que actualizar a lo siguiente:

| Pro Mapping      | Pro Mapping Update |
|------------------|--------------------|
| MSK11            | MSK06              |
| MSK12            | MSK07              |
| MSK13            | MSK08              |
| MSK14            | MSK09              |
| MSK14            | MSK09              |
| MSK14            | MSK09              |
| MSK15            | MSK10              |
| MSK15            | MSK10              |

### Soluci贸n: Dar soporte para 2025 sin afectar a帽os anteriores

El fix que Claudio sugiri贸 fue dar soporte a estos nuevos c贸digos solo para 2025. Entonces el cambio fue pasar el par谩metro `year` a las funciones correspondientes y luego usarlo para hacer el `gsub`. Si el a帽o es 2025, se aplican los nuevos c贸digos. Sino se deja como estaba.

> [!Important]
> En el fix el `gsub` se hace en base al c贸digo MSK01-05. Esto es porque son los c贸digos que devuelve la funci贸n `query`. Haciendo el `gsub` es la forma en que se hace la modificaci贸n sin alterar el resultado de la consulta.

La `query` tiene esta parte desde donde se origina los c贸digos MSK:
```sql
injury_extended
	AS (
		SELECT id
			,UPPER(body_part_type) AS body_part
			,(
				CASE
					-- otros statements
					WHEN inj.body_part_type = 'shoulder_arm' AND #{year} >= 2024
						THEN 'MSK02'
					WHEN inj.body_part_type = 'neck' AND #{year} >= 2024
						THEN 'MSK01'
					WHEN inj.body_part_type = 'lower_back' AND #{year} >= 2024
						THEN 'MSK03'
					WHEN inj.body_part_type = 'hip' AND #{year} >= 2024
						THEN 'MSK04'
					WHEN inj.body_part_type = 'hip_joint_replacement' AND #{year} >= 2024
						THEN 'MSK04'
					WHEN inj.body_part_type = 'foot_and_ankle' AND #{year} >= 2024
						THEN 'MSK04'
					WHEN inj.body_part_type = 'knee' AND #{year} >= 2024
						THEN 'MSK05'
					WHEN inj.body_part_type = 'knee_joint_replacement' AND #{year} >= 2024
						THEN 'MSK05'
```

Esos los dejo quietos para no alterar los dem谩s exports.