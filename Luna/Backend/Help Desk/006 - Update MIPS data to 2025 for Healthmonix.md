# 006 - Update MIPS data to 2025 metrics and send to data Healthmonix

Etiquetas: #luna_help_desk 

Caso EDG-2693

Reporte:
> In preparation to submit for MIPS.
>
> Currently, this data lives in a MIPS Table and ER Files that updates on a daily basis. Historically, the data was sent via SFTP in an autogenerated matter to files on MIPS Pro

# Componentes Clave

## Tabla settings

### `healthmonix_#{year}_integration_enabled`

> [!Important]
> Controls whether files are uploaded to SFTP.

Hay registros por cada año en la tabla `settings` cuya `key` sigue el patrón `healthmonix_#{year}_integration_enabled` que almacena un booleano. Entonces tenemos:

- `healthmonix_2024_integration_enabled`: true
- `healthmonix_2023_integration_enabled`: true
- `healthmonix_2022_integration_enabled`: false

Y la de 2025:

- `healthmonix_2025_integration_enabled`: true

> [!Note]
> Para alpha no existe ninguno de estos registros.

### `healthmonix_#{year}_states`

> [!Important]
> Which states to include.

Este es un setting que guarda una lista de estados de USA en forma abreviada. Sigue el mismo patrón que `healthmonix_#{year}_integration_enabled`.

- `healthmonix_2024_states`: "AZ,CA,FL,IL,TX,WA,GA,NY,CO"
- `healthmonix_2023_states`: "AZ,CA,FL,IL,TX,WA"
- `healthmonix_2022_states`: "CA"

Y para 2025:

- `healthmonix_2025_states`: "AZ,CA,FL,IL,TX,WA,GA,NY,CO"

> [!Note]
> Para alpha no existe ninguno de estos registros.

### `healthmonix_#{year}_strictly_contained`

> [!Important]
> Controls whether to include only care plans that started AND ended within the year

Lo mismo que los dos anteriores. Este setting guarda un valor booleano. Veamos lo que hay:

- `healthmonix_2022_strictly_contained`: true
- `healthmonix_2023_strictly_contained`: false
- `healthmonix_2024_strictly_contained`: false
- `healthmonix_2025_strictly_contained`: false

> [!Note]
> Para alpha no existe ninguno de estos registros.

## Workers

Hay un worker principal que dispara los demás. El orden que sigue es:

- `Athena::HealthmonixCompleteDataWriterWorker`: hace el trigger de `Athena::HealthmonixYearDataWriterWorker` por cada año empezando en 2022
	- Se configura en `periodic_jobs` con cron `CRON_DAILY_AT_2_AM`
- `Athena::HealthmonixYearDataWriterWorker`: hace la generación y export de los datos

Secuencia:
```
Athena::HealthmonixCompleteDataWriterWorker (runs daily at 2:00 AM PT)
		├─> Spawns Athena::HealthmonixYearDataWriterWorker for year 2022
		├─> Spawns Athena::HealthmonixYearDataWriterWorker for year 2023
		├─> Spawns Athena::HealthmonixYearDataWriterWorker for year 2024
		└─> Should spawn for year 2025 (automatic based on current year)
```

## Flujo de los Datos

Según Claudio:

For each year and state:
1. **Query Database**: Complex SQL query filters appointments based on year, state, injury type, etc.
2. **Merge with Forms Data**: Fetches patient assessment forms from AWS Athena
3. **Generate CSV**: Creates CSV with patient outcomes data
4. **Upload to S3**: Stores in `business-operations/healthmonix/{year}/{state}/{date}/data.csv`
5. **Upload to SFTP (if enabled)**: Uses registration ID and integration key to create filename

> [!Note]
> Para alpha, en S3 hay carpetas de 2023 y 2025 pero dada la falta de registros en `settings` no hay datos relevantes.

## Nombre del archivo en el servidor FTP

Claudio dice:

Format:  `Quality_{registration_id}_{integration_key}_{date_string}.csv`

Ejemplos:
- 2023: Includes date string (e.g., `Quality_17625_egAuLG7aVx_20251001.csv`)
- 2024+: No date string (e.g., `Quality_21742_MlUGF8grFd.csv`)

# Problema

El problema parece ser solo para el año 2025 porque no está el case para este año en su lugar.

## Issue 1: Faltan los Registration IDs para 2025

En la función `get_sftp_filename` falta cubrir el año 2025:
```ruby
def get_sftp_filename(year, state)
	registration_id, integration_key =
		case year
		when 2022
			case state.postal_abbreviation
			when "CA"
			else
				["UNKNOWN-2022-REGISTRATION-ID", "UNKNOWN-2022-INTEGRATION-KEY"]
			end
		when 2023
			case state.postal_abbreviation
			when "CA"
			when "AZ"
			when "FL"
			when "IL"
			when "TX"
			when "WA"
			else
				["UNKNOWN-2023-REGISTRATION-ID", "UNKNOWN-2023-INTEGRATION-KEY"]
			end
		when 2024
			case state.postal_abbreviation
			when "CA"
			when "AZ"
			when "FL"
			when "IL"
			when "TX"
			when "WA"
			when "GA"
			when "NY"
			when "CO"
			else
				["UNKNOWN-2023-REGISTRATION-ID", "UNKNOWN-2023-INTEGRATION-KEY"]
			end
		else
			["UNKNOWN-#{year}-REGISTRATION-ID", "UNKNOWN-#{year}-INTEGRATION-KEY"]
		end

	date_string = (Time.zone.today.iso8601.gsub("-", "") if year == 2023)

	"#{['Quality', registration_id, integration_key, date_string].compact.join('_')}.csv"
end
```

### Solución: Dar soporte al año 2025 y copiar los registration IDs 🟢

Los valores están en la spreadsheet que se compartió en el reporte.

## Issue 2: Actualización de código MSK11 al MSK15

